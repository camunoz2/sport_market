name: WhatsApp Notifications

on:
  push:
  pull_request:
    types: [opened, closed]
  issues:
    types: [opened, closed]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Commit Details (if push)
        if: github.event_name == 'push'
        run: |
          echo "EVENT_TYPE=Commit" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_ENV

      - name: Extract PR Details (if PR)
        if: github.event_name == 'pull_request'
        run: |
          echo "EVENT_TYPE=Pull Request" >> $GITHUB_ENV
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "PR_AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
          echo "PR_ACTION=${{ github.event.action }}" >> $GITHUB_ENV

      - name: Extract Issue Details (if issue)
        if: github.event_name == 'issues'
        run: |
          echo "EVENT_TYPE=Issue" >> $GITHUB_ENV
          echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
          echo "ISSUE_AUTHOR=${{ github.event.issue.user.login }}" >> $GITHUB_ENV
          echo "ISSUE_ACTION=${{ github.event.action }}" >> $GITHUB_ENV

      - name: Extract Mentioned User from Comment (if issue comment)
        if: github.event_name == 'issue_comment'
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          MENTIONED_USER=$(echo "$COMMENT_BODY" | grep -o '@[a-zA-Z0-9_-]*' | head -n 1 | tr -d '@')

          echo "EVENT_TYPE=Mention" >> $GITHUB_ENV
          echo "COMMENT_AUTHOR=${{ github.event.comment.user.login }}" >> $GITHUB_ENV
          echo "MENTIONED_USER=$MENTIONED_USER" >> $GITHUB_ENV

      - name: Construct WhatsApp Message
        run: |
          MESSAGE="Unknown event"
          
          case "$EVENT_TYPE" in
            "Commit")
              MESSAGE="📌 *New Commit*\n👤 Author: $COMMIT_AUTHOR\n💬 Message: $COMMIT_MESSAGE"
              ;;
            "Pull Request")
              MESSAGE="🔀 *Pull Request*\n👤 Author: $PR_AUTHOR\n📄 Title: $PR_TITLE\n📢 Action: $PR_ACTION"
              ;;
            "Issue")
              MESSAGE="🐛 *Issue*\n👤 Author: $ISSUE_AUTHOR\n📄 Title: $ISSUE_TITLE\n📢 Action: $ISSUE_ACTION"
              ;;
            "Mention")
              if [ -n "$MENTIONED_USER" ]; then
                MESSAGE="📣 *Mention in Issue*\n👤 $COMMENT_AUTHOR mentioned @$MENTIONED_USER in a comment."
              fi
              ;;
          esac

          echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: Send WhatsApp Notification to Multiple Numbers
        run: |
          NUMBERS="${{ secrets.SANDBOX_NUMBERS }}"
          IFS=',' read -ra PHONE_NUMBERS <<< "$NUMBERS"

          for NUMBER in "${PHONE_NUMBERS[@]}"; do
            echo "Sending message to $NUMBER..."
            curl -X POST "https://api.twilio.com/2010-04-01/Accounts/$TWILIO_ACCOUNT_SID/Messages.json" \
            --data-urlencode "To=whatsapp:$NUMBER" \
            --data-urlencode "From=whatsapp:$TWILIO_WHATSAPP_NUMBER" \
            --data-urlencode "Body=$MESSAGE" \
            -u "$TWILIO_ACCOUNT_SID:$TWILIO_AUTH_TOKEN"
          done
        env:
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_WHATSAPP_NUMBER: ${{ secrets.TWILIO_WHATSAPP_NUMBER }}
          SANDBOX_NUMBERS: ${{ secrets.SANDBOX_NUMBERS }}
